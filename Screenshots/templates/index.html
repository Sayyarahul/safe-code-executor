<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Safe Code Executor</title>

    <!-- Bootstrap CSS (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body { padding: 2rem; background:#f8f9fa; }
      .editor { min-height: 280px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
      pre.output { white-space: pre-wrap; background: #0d1117; color: #c9d1d9; padding: 1rem; border-radius: 6px; min-height: 120px; }
      .history-item { font-family: monospace; font-size: .9rem; }
      .disabled-badge { font-size:.75rem; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row mb-4">
        <div class="col">
          <h1 class="h3">Safe Code Executor</h1>
          <p class="text-muted">Run Python code safely. (JavaScript execution: coming soon)</p>
        </div>
        <div class="col-auto align-self-center">
          <button id="clearHistoryBtn" class="btn btn-outline-secondary btn-sm">Clear History</button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-8">
          <div class="mb-2 d-flex gap-2">
            <select id="language" class="form-select form-select-sm" style="width:160px;">
              <option value="python" selected>Python</option>
              <option value="js" disabled>JavaScript (coming soon)</option>
            </select>

            <button id="runBtn" class="btn btn-primary btn-sm">Run</button>
            <div class="ms-auto text-end">
              <span class="badge bg-warning text-dark disabled-badge">Network disabled on server</span>
            </div>
          </div>

          <textarea id="code" class="form-control editor" spellcheck="false">print("Hello World")</textarea>

          <div class="mt-3">
            <h6 class="mb-1">Output</h6>
            <pre id="output" class="output">(no output yet)</pre>
          </div>
        </div>

        <div class="col-md-4">
          <h6 class="mb-2">Recent runs (local only)</h6>
          <div id="history" class="list-group mb-3" style="max-height:560px; overflow:auto"></div>

          <div class="card">
            <div class="card-body p-3">
              <strong>Notes</strong>
              <ul class="mb-0">
                <li>History is stored in your browser only (localStorage).</li>
                <li>Python runs on the server using the existing `/run` endpoint.</li>
                <li>To enable real JavaScript execution you would need a server-side runner.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (optional, for components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // ====== Client logic: send to /run, store history in localStorage ======
      const MAX_HISTORY = 10;
      const HIST_KEY = 'safe_code_executor_history_v1';

      function loadHistory() {
        const raw = localStorage.getItem(HIST_KEY);
        try {
          return raw ? JSON.parse(raw) : [];
        } catch (e) { return []; }
      }

      function saveHistory(history) {
        localStorage.setItem(HIST_KEY, JSON.stringify(history.slice(-MAX_HISTORY)));
      }

      function renderHistory() {
        const h = loadHistory();
        const container = document.getElementById('history');
        container.innerHTML = '';
        if (h.length === 0) {
          container.innerHTML = '<div class="text-muted small">No recent runs</div>';
          return;
        }
        h.slice().reverse().forEach((item, idx) => {
          const el = document.createElement('button');
          el.type = 'button';
          el.className = 'list-group-item list-group-item-action flex-column align-items-start history-item';
          el.innerHTML = '<div class="d-flex w-100 justify-content-between"><small class="text-muted">' + new Date(item.when).toLocaleString() + '</small></div>'
                       + '<div class="mt-1"><code>' + escapeHtml(item.code).replace(/\n/g,'<br>') + '</code></div>'
                       + '<small class="text-success mt-2">Output:</small><div><pre style="white-space:pre-wrap; margin:0;">' + escapeHtml(item.output) + '</pre></div>';
          el.addEventListener('click', () => {
            document.getElementById('code').value = item.code;
            document.getElementById('output').textContent = item.output;
          });
          container.appendChild(el);
        });
      }

      function escapeHtml(s) {
        if (!s) return '';
        return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      }

      async function runCode() {
        const runBtn = document.getElementById('runBtn');
        runBtn.disabled = true;
        const code = document.getElementById('code').value;
        const lang = document.getElementById('language').value;

        // Only Python supported by server â€” warn if other selected
        if (lang !== 'python') {
          alert('Only Python is supported by the server at the moment.');
          runBtn.disabled = false;
          return;
        }

        document.getElementById('output').textContent = 'Running...';

        try {
          const resp = await fetch('/run', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code })
          });

          const data = await resp.json();
          let out = '';
          if (resp.ok && data.output !== undefined) {
            out = data.output;
            document.getElementById('output').textContent = out || '(no output)';
          } else {
            // show error object nicely
            out = JSON.stringify(data, null, 2);
            document.getElementById('output').textContent = out;
          }

          // store to history
          const history = loadHistory();
          history.push({ when: Date.now(), code, output: out });
          saveHistory(history);
          renderHistory();

        } catch (err) {
          document.getElementById('output').textContent = 'Network or server error: ' + err;
        } finally {
          runBtn.disabled = false;
        }
      }

      document.getElementById('runBtn').addEventListener('click', runCode);
      document.getElementById('clearHistoryBtn').addEventListener('click', () => {
        if (!confirm('Clear local history?')) return;
        localStorage.removeItem(HIST_KEY);
        renderHistory();
      });

      // Initial render
      renderHistory();
    </script>
  </body>
</html>
